# Verso - Node.js LoopbackAPI-based storage middleware

## Introduction

_Verso_ is a boilerplate [Loopback API] (https://loopback.io/) REST application for use with the Library of Congress' [BIBFRAME editor](https://github.com/lcnetdev/bfe) and its related [profile editor](https://github.com/lcnetdev/profile-edit). It offers endpoints for a few different kinds of storage:

1. `/verso/api/bfs`: Memory-based storage of BIBFRAME graphs for use with the BIBFRAME editor.
2. `/verso/api/configs`: Memory-based storage of JSON configuration objects for use with the profile editor.

In addition, _Verso_ supports the standard Loopback user store. Authentication and authorization are not implemented at this time.

You can explore the API using the Loopback API explorer at `/verso/explorer`. The models themselves are in the `common/models` directory.

_Verso_ can be configured to use [MongoDB](https://www.mongodb.com/) or a simple file to persist the memory-based storage. See [Configuring datasource](#configuring-datasource) below.

## Prerequisites

### Optional
_Verso_ can be run using the [PM2 Process Manager](http://pm2.keymetrics.io/).

Installing PM2
```$ npm install pm2 -g```

We use 'bibliomata' as a name for this particular application, so you may want to install everything in a common directory, e.g. {path}/bibliomata/

## Installation

Navigate to your directory you created (e.g. /bibliomata).

```
$ git clone https://github.com/lcnetdev/verso.git
$ cd verso
$ npm install
$ npm start
```

...OR...if using pm2:

```
$ sudo pm2 start server/server.js --name verso
```

The application runs on port 3001 by default.

To check:
```
$ sudo pm2 status
```

You should get a status screen (with a short uptime).

Save:

```
$ sudo pm2 save 
```

This will save a copy of the PM2 config in /root/.pm2/dump.pm2

To restart the cluster with the dump file:

```
$ sudo pm2 resurrect
```

## Configuring Datasource

The `db` datasource can be configured using the following environment variables:

`DB_STORAGE`: If set to `file`, the data for the `db` datasource will be stored and read from a JSON file generated by the `memory` connector. If set to `mongodb`, the data will be stored and read from a MongoDB instance. If this is not set, data will be stored in memory only, and not persisted between runs of the application.

`DB_FILE`: The path to the file for storage if `DB_STORAGE=file`. A file with sample BIBFRAME data (for the /verso/api/bfs endpoint) is included in this repository as `bfpilot.json`.

`DB_URL`: The MongoDB connection string if `DB_STORAGE=mongodb`. Format is `mongodb://[user:password@]host[:port]/db`.

You can configure these variables using a `.env` file in the root directory of the application. For example:

```
# Environment variables
DB_STORAGE=mongodb
DB_URL=mongodb://localhost:27017/test
```

The environment will be picked up by both `npm start` or `pm2`.
